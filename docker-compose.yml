services:
  playwright-tests:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CI=true
      - SITE_URL=http://localhost:4321
      - DOCKER=true
      - SCREENSHOT_TEST_MODE=true
    ports:
      - '4321:4321'
    volumes:
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
    command: >
      sh -c "
        echo 'Starting Astro dev server...' &&
        pnpm dev --host 0.0.0.0 --port 4321 &
        DEV_PID=$$! &&
        echo 'Waiting for server to be ready...' &&
        until curl -s http://localhost:4321 > /dev/null; do 
          echo 'Waiting for server...'
          sleep 1
        done &&
        echo 'Server is ready!' &&
        echo 'Running Playwright tests...' &&
        pnpm exec playwright test &&
        echo 'Tests completed, stopping dev server...' &&
        kill $$DEV_PID
      "

  playwright-update-snapshots:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CI=true
      - SITE_URL=http://localhost:4321
      - DOCKER=true
      - SCREENSHOT_TEST_MODE=true
    ports:
      - '4321:4321'
    volumes:
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
      - ./tests/screenshots:/app/tests/screenshots
    command: >
      sh -c "
        echo 'Starting Astro dev server...' &&
        pnpm dev --host 0.0.0.0 --port 4321 &
        DEV_PID=$$! &&
        echo 'Waiting for server to be ready...' &&
        until curl -s http://localhost:4321 > /dev/null; do 
          echo 'Waiting for server...'
          sleep 1
        done &&
        echo 'Server is ready!' &&
        echo 'Updating Playwright snapshots...' &&
        pnpm exec playwright test --update-snapshots &&
        echo 'Snapshots updated, stopping dev server...' &&
        kill $$DEV_PID
      "
